<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‡ãƒƒã‚­ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    .input-section {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    .sort-buttons {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
    .sort-buttons button {
      padding: 8px 12px;
      font-size: 12px;
    }
    .deck-list {
      list-style: none;
    }
    .card-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: move;
      transition: background 0.2s;
    }
    .card-item:hover {
      background: #f0f0f0;
    }
    .card-item.dragging {
      opacity: 0.5;
    }
    .drag-handle {
      color: #999;
      cursor: grab;
    }
    .card-item input {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
    }
    .card-count {
      width: 40px;
      padding: 5px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .btn-delete {
      background: #dc3545;
      padding: 6px 12px;
      font-size: 12px;
    }
    .btn-delete:hover {
      background: #c82333;
    }
    .stats {
      margin-top: 20px;
      padding: 15px;
      background: #e7f3ff;
      border-radius: 4px;
      font-size: 14px;
    }
    .stats p {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸƒ ãƒ‡ãƒƒã‚­ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="input-section">
      <input type="text" id="cardName" placeholder="ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›">
      <input type="number" id="cardCount" min="1" max="99" value="1" style="width: 60px;">
      <button onclick="addCard()">è¿½åŠ </button>
    </div>

    <div style="margin-bottom:12px;">
      <div id="tagControls" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <!-- ã‚¿ã‚°é¸æŠãƒœã‚¿ãƒ³ï¼ˆJSã§æç”»ã•ã‚Œã¾ã™ï¼‰ -->
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <input type="text" id="customTagInput" placeholder="ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦Enterã§è¿½åŠ " style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;">
        <button id="addCustomTagBtn">ã‚¿ã‚°è¿½åŠ </button>
      </div>
    </div>

    <div class="sort-buttons">
      <button onclick="sortByCount()">æšæ•°é †ã«ã‚½ãƒ¼ãƒˆ</button>
      <button onclick="sortByName()">åå‰é †ã«ã‚½ãƒ¼ãƒˆ</button>
      <button onclick="exportToSheetsPrompt()">Google Sheetsã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>

    <ul id="deckList" class="deck-list"></ul>

    <div class="stats">
      <p>ç·ã‚«ãƒ¼ãƒ‰æšæ•°: <strong id="totalCards">0</strong></p>
      <p>ã‚«ãƒ¼ãƒ‰ç¨®é¡æ•°: <strong id="cardTypes">0</strong></p>
    </div>
  </div>

  <script>
    let deck = [];
    let allTags = ['ST', 'GS', 'é©å‘½X','æ¡ä»¶ST'];
    let selectedTags = [];

    function renderTagControls() {
      const container = document.getElementById('tagControls');
      container.innerHTML = '';
      allTags.forEach(tag => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = tag;
        const isSelected = selectedTags.includes(tag);
        btn.style.padding = '6px 10px';
        btn.style.fontSize = '13px';
        btn.style.borderRadius = '16px';
        btn.style.border = isSelected ? '1px solid #007bff' : '1px solid #ddd';
        btn.style.background = isSelected ? '#e6f0ff' : '#fff';
        btn.style.cursor = 'pointer';
        btn.style.margin = '2px';
        if (isSelected) btn.style.color = '#007bff';
        btn.addEventListener('click', () => { toggleTag(tag); });
        container.appendChild(btn);
      });
    }

    function toggleTag(tag) {
      if (selectedTags.includes(tag)) selectedTags = selectedTags.filter(t => t !== tag);
      else {
        if (!allTags.includes(tag)) allTags.push(tag);
        selectedTags.push(tag);
      }
      renderTagControls();
    }

    document.getElementById('addCustomTagBtn').addEventListener('click', () => {
      const input = document.getElementById('customTagInput');
      const tag = input.value.trim();
      if (!tag) return;
      if (!allTags.includes(tag)) allTags.push(tag);
      if (!selectedTags.includes(tag)) selectedTags.push(tag);
      input.value = '';
      renderTagControls();
      document.getElementById('cardName').focus();
    });

    document.getElementById('customTagInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('addCustomTagBtn').click();
      }
    });

    function addCard() {
      const nameInput = document.getElementById('cardName');
      const countInput = document.getElementById('cardCount');
      const name = nameInput.value.trim();
      const count = parseInt(countInput.value);
      const tags = [...selectedTags];

      if (!name) {
        alert('ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const existing = deck.find(card => card.name === name);
      if (existing) {
        existing.count += count;
        existing.tags = Array.from(new Set([...(existing.tags || []), ...tags]));
      } else {
        deck.push({ id: Date.now(), name, count, tags: tags.slice() });
      }

      selectedTags = [];
      renderTagControls();

      nameInput.value = '';
      countInput.value = '1';
      nameInput.focus();
      
      sortByCount();
      renderDeck();
    }

    function deleteCard(id) {
      deck = deck.filter(card => card.id !== id);
      renderDeck();
    }

    function updateCard(id, name, count, tags) {
      const card = deck.find(c => c.id === id);
      if (card) {
        card.name = name.trim();
        card.count = parseInt(count) || 1;
        if (Array.isArray(tags)) card.tags = tags;
        sortByCount();
        renderDeck();
      }
    }

    function addTagToCard(id, tag) {
      if (!tag) return;
      const card = deck.find(c => c.id === id);
      if (!card) return;
      card.tags = card.tags || [];
      if (!card.tags.includes(tag)) card.tags.push(tag);
      if (!allTags.includes(tag)) allTags.push(tag);
      renderDeck();
    }

    function removeTagFromCard(id, tag) {
      const card = deck.find(c => c.id === id);
      if (!card || !card.tags) return;
      card.tags = card.tags.filter(t => t !== tag);
      renderDeck();
    }

    function sortByCount() {
      deck.sort((a, b) => b.count - a.count);
    }

    function sortByName() {
      deck.sort((a, b) => a.name.localeCompare(b.name));
    }

    function renderDeck() {
      const list = document.getElementById('deckList');
      list.innerHTML = '';

      deck.forEach((card, index) => {
        const li = document.createElement('li');
        li.className = 'card-item';
        li.draggable = true;
        li.style.flexWrap = 'wrap';
        li.style.alignItems = 'flex-start';

        const dragHandle = document.createElement('span');
        dragHandle.className = 'drag-handle';
        dragHandle.textContent = 'â‹®â‹®';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = card.name;

        const countInput = document.createElement('input');
        countInput.type = 'number';
        countInput.className = 'card-count';
        countInput.min = 1;
        countInput.max = 99;
        countInput.value = card.count;

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã¯ä¸Šæ®µã«é…ç½®
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete';
        delBtn.textContent = 'å‰Šé™¤';
        delBtn.addEventListener('click', () => deleteCard(card.id));

        // ä¸Šæ®µï¼ˆã‚«ãƒ¼ãƒ‰åãƒ»æšæ•°ãƒ»å‰Šé™¤ï¼‰
        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'center';
        topRow.style.gap = '8px';
        topRow.style.width = '100%';
        nameInput.addEventListener('change', () => updateCard(card.id, nameInput.value, countInput.value));
        countInput.addEventListener('change', () => updateCard(card.id, nameInput.value, countInput.value));
        topRow.appendChild(dragHandle);
        topRow.appendChild(nameInput);
        topRow.appendChild(countInput);
        topRow.appendChild(delBtn);

        // ã‚¿ã‚°è¡¨ç¤ºã¯ä¸‹æ®µï¼ˆã‚«ãƒ¼ãƒ‰åã®ä¸‹ï¼‰ã«é…ç½®
        const tagContainer = document.createElement('div');
        tagContainer.style.display = 'flex';
        tagContainer.style.gap = '6px';
        tagContainer.style.flexWrap = 'wrap';
        tagContainer.style.alignItems = 'center';
        tagContainer.style.marginTop = '8px';
        tagContainer.style.width = '100%';

        (card.tags || []).forEach(tag => {
          const chip = document.createElement('span');
          chip.textContent = tag + ' Ã—';
          chip.style.padding = '6px 10px';
          chip.style.fontSize = '13px';
          chip.style.border = '1px solid #ddd';
          chip.style.borderRadius = '14px';
          chip.style.background = '#fff';
          chip.style.cursor = 'pointer';
          chip.addEventListener('click', () => removeTagFromCard(card.id, tag));
          tagContainer.appendChild(chip);
        });

        const tagAddInput = document.createElement('input');
        tagAddInput.type = 'text';
        tagAddInput.placeholder = 'ã‚¿ã‚°è¿½åŠ ';
        tagAddInput.style.padding = '6px';
        tagAddInput.style.border = '1px solid #ddd';
        tagAddInput.style.borderRadius = '4px';
        tagAddInput.style.marginTop = '6px';
        tagAddInput.style.width = '140px';
        tagAddInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const value = tagAddInput.value.trim();
            if (value) {
              addTagToCard(card.id, value);
              tagAddInput.value = '';
            }
          }
        });

        li.appendChild(topRow);
        li.appendChild(tagContainer);
        li.appendChild(tagAddInput);

        li.addEventListener('dragstart', () => li.classList.add('dragging'));
        li.addEventListener('dragend', () => li.classList.remove('dragging'));
        li.addEventListener('dragover', (e) => e.preventDefault());
        li.addEventListener('drop', () => {
          const items = [...document.querySelectorAll('.card-item')];
          const dragIndex = items.indexOf(document.querySelector('.card-item.dragging'));
          if (dragIndex === -1) return;
          [deck[dragIndex], deck[index]] = [deck[index], deck[dragIndex]];
          renderDeck();
        });

        list.appendChild(li);
      });

      updateStats();
    }

    function updateStats() {
      const total = deck.reduce((sum, card) => sum + card.count, 0);
      document.getElementById('totalCards').textContent = total;
      document.getElementById('cardTypes').textContent = deck.length;
    }

    document.getElementById('cardName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addCard();
    });

    // Google Apps Script ã«ãƒ‡ãƒƒã‚­ã‚’é€ä¿¡ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹
    async function exportToAppsScript(url) {
      if (!url) url = prompt('Apps Script Web App URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸWebã‚¢ãƒ—ãƒªã®URLï¼‰:');
      if (!url) return;
      if (!deck || deck.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deck })
        });
        const data = await res.json();
        if (res.ok && data.url) {
          alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: ' + data.url);
          window.open(data.url, '_blank');
        } else if (res.ok) {
          alert('é€ä¿¡æˆåŠŸ: ' + JSON.stringify(data));
        } else {
          alert('é€ä¿¡å¤±æ•—: ' + res.status + ' ' + res.statusText + '\n' + JSON.stringify(data));
        }
      } catch (err) {
        alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
      }
    }

    function exportToSheetsPrompt() {
      const defaultUrl = 'https://script.google.com/macros/s/AKfycbxR7i8tnkJ7GWJGdd_LByjCEGBDZwtrUkrxQTDH2jF6k9Wcg2ucSBmk952UTkGKkpMR/exec'; // ã‚ã‚‰ã‹ã˜ã‚ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ Web App ã® URL ã‚’å…¥ã‚Œã¦ãŠãã“ã¨ã‚‚ã§ãã¾ã™
      const url = prompt('Apps Script Web App URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', defaultUrl);
      if (url) exportToAppsScript(url);
    }

    // åˆæœŸæç”»
    renderTagControls();
    renderDeck();
  </script>
</body>
</html>